{"name":"cd997bfb7b","creation":"2024-11-20 11:41:46.597022","modified":"2024-11-20 11:41:46.597022","modified_by":"deploymentmaster@lmnas.com","owner":"deploymentmaster@lmnas.com","docstatus":0,"idx":0,"deleted_name":"Design Gitra XML Beta","deleted_doctype":"Client Script","restored":0,"new_name":null,"data":"{\n \"creation\": \"2024-11-20 11:41:37.033726\",\n \"docstatus\": 0,\n \"doctype\": \"Client Script\",\n \"dt\": \"Design\",\n \"enabled\": 1,\n \"idx\": 0,\n \"modified\": \"2024-11-20 11:41:37.033726\",\n \"modified_by\": \"deploymentmaster@lmnas.com\",\n \"module\": null,\n \"name\": \"Design Gitra XML Beta\",\n \"owner\": \"deploymentmaster@lmnas.com\",\n \"script\": \"//In earlier, we have set the value 5 or 20 for the Gitra Calculation\\n//By using the K4 factor.\\n//But now we have directly set that the value into the field THDi\\nfrappe.ui.form.on(\\\"Design\\\", {\\n  validate(frm) {\\n    if (\\n      frm.doc.factory === \\\"SGBCZ\\\" &&\\n      frm.doc.transformer_type === \\\"DTTHZ2N\\\" &&\\n      frm.doc.is_design &&\\n      frm.doc.status === \\\"Draft\\\"\\n    ) {\\n      function fnAddTappingsXml(frm, iXml, iaTappingNodes) {\\n        // Parse the XML template to JavaScript object\\n        let loXmlDoc = new DOMParser().parseFromString(iXml, \\\"text/xml\\\");\\n        var lNodeList = loXmlDoc.getElementsByTagName(\\n          \\\"TGtExportEDSAuftragStellungenListe\\\"\\n        );\\n        // Check if the element exists\\n        if (lNodeList.length > 0) {\\n          var lTargetNode = lNodeList[0];\\n\\n          // Add the new nodes to the target element\\n          iaTappingNodes.forEach(function (iNodeData) {\\n            var lNewNode = loXmlDoc.createElement(\\n              \\\"TGtExportEDSAuftragStellung\\\"\\n            );\\n            lNewNode.setAttribute(\\\"nodetype\\\", \\\"class\\\");\\n            var lSpannungNode = loXmlDoc.createElement(\\\"spannung\\\");\\n            lSpannungNode.setAttribute(\\\"nodetype\\\", \\\"property\\\");\\n            lSpannungNode.setAttribute(\\\"datatype\\\", \\\"xs:double\\\");\\n            var lSpannungText = loXmlDoc.createTextNode(iNodeData.spannung);\\n            lSpannungNode.appendChild(lSpannungText);\\n            lNewNode.appendChild(lSpannungNode);\\n            lTargetNode.appendChild(lNewNode);\\n            lTargetNode.appendChild(loXmlDoc.createTextNode(\\\"\\\\n\\\"));\\n          });\\n        }\\n        // Convert the XML document to a string\\n        var lXmlString = new XMLSerializer().serializeToString(loXmlDoc);\\n        //return lXmlString;\\n        return fnFormatXml(lXmlString);\\n      }\\n      function fnFormatXml(iXml, iTab) {\\n        // tab = optional indent value, default is tab (\\\\t)\\n        var lFormatted = \\\"\\\",\\n          lIndent = \\\"\\\";\\n        iTab = iTab || \\\"\\\\t\\\";\\n        iXml.split(/>\\\\s*</).forEach(function (iNode) {\\n          // decrease indent by one 'tab'\\n          if (iNode.match(/^\\\\/\\\\w/)) lIndent = lIndent.substring(iTab.length);\\n          lFormatted += lIndent + \\\"<\\\" + iNode + \\\">\\\\r\\\\n\\\";\\n          // increase indent\\n          if (iNode.match(/^<?\\\\w[^>]*[^\\\\/]$/)) lIndent += iTab; \\n        });\\n        return lFormatted.substring(1, lFormatted.length - 3);\\n      }\\n\\n      function fnGetTappingNodes(frm, iaTappingNodes, iTapping, iSign) {\\n        for (var i = 1; i <= frm.doc[iTapping]; i++) {\\n          var ldTappingNode = { spannung: \\\"\\\" };\\n          var lTappingStep = iTapping + \\\"_step\\\";\\n          ldTappingNode.spannung =\\n            frm.doc.hv_rated_voltage +\\n            (iSign * i * frm.doc[lTappingStep] * frm.doc.hv_rated_voltage) /\\n              100;\\n          iaTappingNodes.push(ldTappingNode);\\n        }\\n        return iaTappingNodes;\\n      }\\n\\n      var lDoctype = \\\"Gitra Settings\\\";\\n      // Initialize the model with doctype Gitra Settings\\n      frappe.model.with_doc(lDoctype, lDoctype, function () {\\n        // Then from the model get the list.\\n        //This will return all attributes of the model including child table\\n        var laValues = frappe.model.get_list(lDoctype);\\n        // Regular expression pattern to match variables in double curly braces\\n        var lPattern = /\\\\{\\\\{([\\\\w.]+)\\\\}\\\\}/g;\\n\\n        // Resolve expressions and variables\\n        var lXml = laValues[0].gitra_xml.replace(\\n          lPattern,\\n          function (match, iVariable) {\\n            var lValue = \\\"\\\";\\n            //Commented this block for using the THDi directly\\n            //instead of k4_factor\\n            //if(iVariable==='frm.doc.k4_factor'){\\n            //  var lk4 = frm.doc.k4_factor == \\\"Yes\\\" ? '6395' : '6396';\\n            //  lValue = lk4;\\n            //} else {\\n            //  lValue = eval(iVariable);\\n            //}\\n            switch (iVariable) {\\n              case \\\"frm.doc.thdi\\\":\\n                var lThdi = frm.doc.thdi == \\\"20\\\" ? \\\"6395\\\" : \\\"6396\\\";\\n                lValue = lThdi;\\n                break;\\n\\n              case \\\"frm.doc.vector_group\\\":\\n                //Trim the Number from Vector group\\n                //only option [1,5,7,11] is accepted in gitra\\n                let vectorGroup = frm.doc.vector_group;\\n                lValue = vectorGroup.replace(/\\\\D/g, \\\"\\\");\\n                break;\\n\\n              default:\\n                //inorder to prevent falsy in xml\\n                //convert it into string\\n                lValue = String(eval(iVariable));\\n                break;\\n            }\\n            return lValue || \\\"\\\";\\n          }\\n        );\\n        let laTappingNodes = [];\\n        laTappingNodes = fnGetTappingNodes(\\n          frm,\\n          laTappingNodes,\\n          \\\"tapping_minus\\\",\\n          -1\\n        );\\n        laTappingNodes = fnGetTappingNodes(\\n          frm,\\n          laTappingNodes,\\n          \\\"tapping_plus\\\",\\n          1\\n        );\\n\\n        var lXmlString = fnAddTappingsXml(frm, lXml, laTappingNodes);\\n\\n        frm.doc.gitra_xml = lXmlString;\\n      });\\n\\n      frm.refresh_fields();\\n    }\\n  },\\n});\\n\",\n \"view\": \"Form\"\n}","_user_tags":null,"_comments":null,"_assign":null,"_liked_by":null}